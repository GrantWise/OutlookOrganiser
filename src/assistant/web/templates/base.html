<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Outlook AI Assistant{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“§</text></svg>">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/htmx.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar navigation -->
        <nav class="sidebar">
            <div class="sidebar-brand">
                <h1>Outlook AI</h1>
                <p>Email Assistant</p>
            </div>
            <ul class="nav-list">
                <li class="nav-item {% if nav_active == 'dashboard' %}active{% endif %}">
                    <a href="/">Dashboard</a>
                </li>
                <li class="nav-item {% if nav_active == 'review' %}active{% endif %}">
                    <a href="/review">
                        Review Queue
                        {% if pending_count is defined and pending_count %}
                        <span class="nav-badge" id="pending-badge">{{ pending_count }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item {% if nav_active == 'waiting' %}active{% endif %}">
                    <a href="/waiting">Waiting For</a>
                </li>
                <li class="nav-item {% if nav_active == 'stats' %}active{% endif %}">
                    <a href="/stats">Stats</a>
                </li>
                <li class="nav-item {% if nav_active == 'senders' %}active{% endif %}">
                    <a href="/senders">Senders</a>
                </li>
                <li class="nav-item {% if nav_active == 'config' %}active{% endif %}">
                    <a href="/config">Config</a>
                </li>
                <li class="nav-item {% if nav_active == 'log' %}active{% endif %}">
                    <a href="/log">Activity Log</a>
                </li>
            </ul>
        </nav>

        <!-- Main content area -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Toast notification container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Listen for HTMX showToast events
        document.body.addEventListener("showToast", function(evt) {
            var msg = evt.detail.value || evt.detail;
            var container = document.getElementById("toast-container");
            var toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        });

        // Toggle snippet expansion
        document.addEventListener("click", function(evt) {
            if (evt.target.classList.contains("expand-toggle")) {
                var snippet = evt.target.closest(".suggestion-card")
                    .querySelector(".suggestion-snippet");
                if (snippet) {
                    snippet.classList.toggle("expanded");
                    evt.target.textContent = snippet.classList.contains("expanded")
                        ? "Show less" : "Show more";
                }
            }
        });

        // Toggle reasoning visibility
        document.addEventListener("click", function(evt) {
            if (evt.target.classList.contains("reasoning-toggle")) {
                var reasoning = evt.target.nextElementSibling;
                if (reasoning) {
                    reasoning.style.display = reasoning.style.display === "none" ? "block" : "none";
                    evt.target.textContent = reasoning.style.display === "none"
                        ? "Show reasoning" : "Hide reasoning";
                }
            }
        });

        // Toggle correction form
        document.addEventListener("click", function(evt) {
            if (evt.target.classList.contains("btn-correct")) {
                var card = evt.target.closest(".suggestion-card");
                if (card) {
                    var form = card.querySelector(".correct-form");
                    if (form) {
                        form.classList.toggle("active");
                    }
                }
            }
        });

        // ---------------------------------------------------------------
        // Cascading folder dropdown
        // ---------------------------------------------------------------
        (function() {
            var treeEl = document.getElementById("folder-tree-data");
            if (!treeEl) return;

            var folderTree = JSON.parse(treeEl.textContent);

            // Top-level select changed
            document.addEventListener("change", function(evt) {
                var sel = evt.target;
                if (!sel.classList.contains("folder-top")) return;

                var sid = sel.dataset.suggestionId;
                var subSel = document.getElementById("folder-sub-" + sid);
                var hidden = document.getElementById("folder-" + sid);
                var topVal = sel.value;

                if (!topVal) {
                    subSel.style.display = "none";
                    subSel.innerHTML = '<option value="">-- No subfolder --</option>';
                    hidden.value = "";
                    return;
                }

                var subs = folderTree[topVal] || [];
                var html = '<option value="">-- No subfolder --</option>';
                for (var i = 0; i < subs.length; i++) {
                    html += '<option value="' + subs[i].replace(/"/g, '&quot;') + '">'
                          + subs[i].replace(/</g, '&lt;') + '</option>';
                }
                subSel.innerHTML = html;
                subSel.style.display = subs.length > 0 ? "" : "none";
                hidden.value = topVal;
            });

            // Sub-level select changed
            document.addEventListener("change", function(evt) {
                var sel = evt.target;
                if (!sel.classList.contains("folder-sub")) return;

                var sid = sel.dataset.suggestionId;
                var topSel = document.getElementById("folder-top-" + sid);
                var hidden = document.getElementById("folder-" + sid);
                var topVal = topSel.value;
                var subVal = sel.value;

                hidden.value = subVal ? topVal + "/" + subVal : topVal;
            });
        })();

        // ---------------------------------------------------------------
        // Chat panel
        // ---------------------------------------------------------------
        (function() {
            var chatPanel = document.getElementById("chat-panel");
            var chatOverlay = document.getElementById("chat-overlay");
            if (!chatPanel) return; // Only present on review page

            var chatMessages = document.getElementById("chat-messages");
            var chatInput = document.getElementById("chat-input");
            var chatSend = document.getElementById("chat-send");
            var chatClose = document.getElementById("chat-close");
            var chatLoading = document.getElementById("chat-loading");
            var chatTitle = document.getElementById("chat-panel-title");
            var chatSubtitle = document.getElementById("chat-panel-subtitle");

            var currentSuggestionId = null;
            var messageHistory = [];
            var isSending = false;

            // Open chat panel
            document.addEventListener("click", function(evt) {
                var btn = evt.target.closest(".btn-discuss");
                if (!btn) return;
                currentSuggestionId = parseInt(btn.dataset.suggestionId, 10);
                var subject = btn.dataset.emailSubject || "Email";
                var sender = btn.dataset.senderEmail || "";
                chatTitle.textContent = "Discuss Classification";
                chatSubtitle.textContent = subject + (sender ? " â€” " + sender : "");
                messageHistory = [];
                chatMessages.innerHTML = "";
                chatPanel.classList.add("open");
                if (chatOverlay) chatOverlay.classList.add("open");
                chatInput.focus();
            });

            // Close chat panel
            function closeChat() {
                chatPanel.classList.remove("open");
                if (chatOverlay) chatOverlay.classList.remove("open");
                currentSuggestionId = null;
                messageHistory = [];
            }
            chatClose.addEventListener("click", closeChat);
            if (chatOverlay) chatOverlay.addEventListener("click", closeChat);

            // Send message
            function sendMessage() {
                if (isSending) return;
                var text = chatInput.value.trim();
                if (!text || !currentSuggestionId) return;

                // Append user message to UI
                appendMessage("user", text);
                messageHistory.push({ role: "user", content: text });
                chatInput.value = "";
                chatInput.style.height = "auto";

                // Show loading
                isSending = true;
                chatLoading.style.display = "flex";
                chatSend.disabled = true;

                fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        suggestion_id: currentSuggestionId,
                        messages: messageHistory
                    })
                })
                .then(function(res) {
                    if (!res.ok) {
                        return res.json().then(function(data) {
                            throw new Error(data.detail || "Chat request failed");
                        });
                    }
                    return res.json();
                })
                .then(function(data) {
                    // Append assistant reply
                    appendMessage("assistant", data.reply);
                    messageHistory.push({ role: "assistant", content: data.reply });

                    // Show tool results as status messages
                    if (data.actions_taken && data.actions_taken.length > 0) {
                        data.actions_taken.forEach(function(action) {
                            appendMessage("tool-result", action.tool_name + ": " + action.result);
                        });

                        // If a reclassify happened, remove the suggestion card
                        var hasReclassify = data.actions_taken.some(function(a) {
                            return a.tool_name === "reclassify_email";
                        });
                        if (hasReclassify) {
                            var card = document.getElementById("suggestion-" + currentSuggestionId);
                            if (card) {
                                card.style.transition = "opacity 0.3s, transform 0.3s";
                                card.style.opacity = "0";
                                card.style.transform = "translateX(50px)";
                                setTimeout(function() { card.remove(); }, 300);
                            }
                        }
                    }
                })
                .catch(function(err) {
                    appendMessage("error", err.message || "Something went wrong");
                })
                .finally(function() {
                    isSending = false;
                    chatLoading.style.display = "none";
                    chatSend.disabled = false;
                    chatInput.focus();
                });
            }

            chatSend.addEventListener("click", sendMessage);
            chatInput.addEventListener("keydown", function(evt) {
                if (evt.key === "Enter" && !evt.shiftKey) {
                    evt.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            chatInput.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = Math.min(this.scrollHeight, 120) + "px";
            });

            // Append a message bubble to the chat area
            function appendMessage(type, text) {
                var div = document.createElement("div");
                div.className = "chat-message " + type;
                div.textContent = text;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        })();
    </script>
</body>
</html>
