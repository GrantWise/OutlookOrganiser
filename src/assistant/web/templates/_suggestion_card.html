{# Partial template for a single suggestion card.
   Context: item = {"suggestion": Suggestion, "email": Email}
            folder_tree = dict of top-level -> subfolder list (from Graph API)
            folder_options = flat list of folder paths (fallback when folder_tree is None)
#}
{% set s = item.suggestion %}
{% set email = item.email %}

<div class="suggestion-card" id="suggestion-{{ s.id }}">
    <!-- Header: subject + received date -->
    <div class="suggestion-header">
        <span class="suggestion-subject">{{ email.subject if email else "Unknown Subject" }}</span>
        <span class="suggestion-meta" title="Received">{{ email.received_at | format_received if email and email.received_at else "Unknown" }}</span>
    </div>

    <!-- Sender info -->
    <div class="suggestion-meta">
        {% if email %}
            {{ email.sender_name or "" }}
            {% if email.sender_email %}&lt;{{ email.sender_email }}&gt;{% endif %}
        {% endif %}
    </div>

    <!-- Snippet -->
    {% if email and email.snippet %}
    <div class="suggestion-snippet">{{ email.snippet[:200] }}</div>
    {% if email.snippet | length > 200 %}
    <button class="expand-toggle reasoning-toggle" type="button">Show more</button>
    {% endif %}
    {% endif %}

    <!-- Classification row -->
    <div class="classification-row">
        {% if s.suggested_folder %}
        <span class="badge badge-folder">{{ s.suggested_folder }}</span>
        {% endif %}
        {% if s.suggested_priority %}
        <span class="badge {{ s.suggested_priority | priority_class }}">{{ s.suggested_priority }}</span>
        {% endif %}
        {% if s.suggested_action_type %}
        <span class="badge badge-action">{{ s.suggested_action_type }}</span>
        {% endif %}
    </div>

    <!-- Confidence bar -->
    {% if s.confidence is not none %}
    <div class="confidence-bar {{ s.confidence | confidence_class }}">
        <div class="confidence-track">
            <div class="confidence-fill" style="width: {{ (s.confidence * 100) | int }}%"></div>
        </div>
        <span class="confidence-value">{{ (s.confidence * 100) | int }}%</span>
    </div>
    {% endif %}

    <!-- Reasoning -->
    {% if s.reasoning %}
    <div>
        <button class="reasoning-toggle" type="button">Show reasoning</button>
        <div class="reasoning" style="display: none;">{{ s.reasoning }}</div>
    </div>
    {% endif %}

    <!-- Action buttons -->
    <div class="action-row">
        <button class="btn btn-approve"
                hx-post="/api/suggestions/{{ s.id }}/approve"
                hx-target="#suggestion-{{ s.id }}"
                hx-swap="outerHTML swap:0.3s">
            Approve
        </button>
        <button class="btn btn-correct" type="button">
            Correct
        </button>
        <button class="btn btn-reject"
                hx-post="/api/suggestions/{{ s.id }}/reject"
                hx-target="#suggestion-{{ s.id }}"
                hx-swap="outerHTML swap:0.3s">
            Reject
        </button>
        <button class="btn btn-discuss" type="button"
                data-suggestion-id="{{ s.id }}"
                data-email-subject="{{ email.subject if email else 'Unknown' }}"
                data-sender-email="{{ email.sender_email if email else '' }}">
            Discuss
        </button>
        {% if email and email.web_link %}
        <a class="btn btn-link" href="{{ email.web_link }}" target="_blank" rel="noopener">
            Open in Outlook
        </a>
        {% endif %}
    </div>

    <!-- Correction form (hidden by default) -->
    <div class="correct-form">
        <div class="form-row">
            <div>
                <label for="folder-{{ s.id }}">Folder</label>
                {% if folder_tree %}
                {# Cascading two-level dropdown from live Outlook folders #}
                {% set suggested_top = s.suggested_folder.split('/')[0] if s.suggested_folder and '/' in s.suggested_folder else '' %}
                {% set suggested_sub = '/'.join(s.suggested_folder.split('/')[1:]) if s.suggested_folder and '/' in s.suggested_folder else '' %}
                <div class="folder-cascade" data-suggestion-id="{{ s.id }}">
                    <select class="folder-top" id="folder-top-{{ s.id }}"
                            data-suggestion-id="{{ s.id }}">
                        <option value="">-- Keep suggested --</option>
                        {% for top_name in folder_tree.keys() | sort %}
                        <option value="{{ top_name }}"
                            {% if suggested_top == top_name %}selected{% endif %}>
                            {{ top_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <select class="folder-sub" id="folder-sub-{{ s.id }}"
                            data-suggestion-id="{{ s.id }}"
                            {% if not suggested_top or not folder_tree.get(suggested_top, []) %}style="display:none"{% endif %}>
                        <option value="">-- No subfolder --</option>
                        {% if suggested_top and suggested_top in folder_tree %}
                            {% for sub in folder_tree[suggested_top] %}
                            <option value="{{ sub }}"
                                {% if sub == suggested_sub %}selected{% endif %}>
                                {{ sub }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <input type="hidden" id="folder-{{ s.id }}" name="folder"
                           value="">
                </div>
                {% else %}
                {# Fallback: flat dropdown from config #}
                <select id="folder-{{ s.id }}" name="folder">
                    <option value="">-- Keep suggested --</option>
                    {% for f in folder_options %}
                    <option value="{{ f }}" {% if f == s.suggested_folder %}selected{% endif %}>{{ f }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
            <div>
                <label for="priority-{{ s.id }}">Priority</label>
                <select id="priority-{{ s.id }}" name="priority">
                    <option value="">-- Keep suggested --</option>
                    <option value="P1 - Urgent" {% if s.suggested_priority == "P1 - Urgent" %}selected{% endif %}>P1 - Urgent</option>
                    <option value="P2 - Important" {% if s.suggested_priority == "P2 - Important" %}selected{% endif %}>P2 - Important</option>
                    <option value="P3 - Normal" {% if s.suggested_priority == "P3 - Normal" %}selected{% endif %}>P3 - Normal</option>
                    <option value="P4 - Low" {% if s.suggested_priority == "P4 - Low" %}selected{% endif %}>P4 - Low</option>
                </select>
            </div>
            <div>
                <label for="action-{{ s.id }}">Action Type</label>
                <select id="action-{{ s.id }}" name="action_type">
                    <option value="">-- Keep suggested --</option>
                    <option value="Needs Reply">Needs Reply</option>
                    <option value="Review">Review</option>
                    <option value="FYI Only">FYI Only</option>
                    <option value="Waiting For">Waiting For</option>
                    <option value="Delegate">Delegate</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary btn-sm"
                hx-post="/api/suggestions/{{ s.id }}/approve"
                hx-target="#suggestion-{{ s.id }}"
                hx-swap="outerHTML swap:0.3s"
                hx-include="[id^='folder-{{ s.id }}'],[id^='priority-{{ s.id }}'],[id^='action-{{ s.id }}']"
                hx-vals='js:{
                    "folder": document.getElementById("folder-{{ s.id }}").value || null,
                    "priority": document.getElementById("priority-{{ s.id }}").value || null,
                    "action_type": document.getElementById("action-{{ s.id }}").value || null
                }'>
            Apply Corrections
        </button>
    </div>
</div>
